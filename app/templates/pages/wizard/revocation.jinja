{% extends('layouts/base.jinja') %}
{% block page %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Revocation Info Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-ban me-2"></i>
                    Credential Revocation
                </h3>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="text-center mb-4 mb-lg-0">
                            <div class="shape shape-lg mb-3">
                                <i class="ti ti-ban icon icon-2 text-danger"></i>
                            </div>
                            <h2 class="mb-3">Test Revocation</h2>
                            <p class="text-muted mb-4">The credential has been revoked. A new presentation request has been sent to your wallet to demonstrate that revoked credentials fail verification.</p>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <!-- Revocation Process -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="ti ti-timeline me-2"></i>
                                    Revocation Process
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="shape shape-sm me-3">
                                                <i class="ti ti-check icon icon-1 text-success"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Credential Revoked</h6>
                                                <small class="text-muted">Status updated in revocation registry</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="shape shape-sm me-3">
                                                <i class="ti ti-send icon icon-1 text-info"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">New Request Sent</h6>
                                                <small class="text-muted">Presentation request sent to wallet</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="shape shape-sm me-3">
                                                <i class="ti ti-x icon icon-1 text-danger"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Expected Result</h6>
                                                <small class="text-muted">Verification should fail (credential revoked)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revocation Verification Status Card -->
        <div class="card mt-4" id="revocation-status-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-shield-x me-2"></i>
                    Revoked Credential Verification
                </h3>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center" id="revocation-status-content">
                    {% if session.demo.revocation_presentation_state == 'done' and session.demo.revocation_presentation_verified == 'false' %}
                        <div class="shape shape-md me-3">
                            <i class="ti ti-check icon icon-1 text-success"></i>
                        </div>
                        <div class="flex-fill">
                            <h4 class="mb-1 text-success">Revocation Verified</h4>
                            <p class="text-muted mb-0">As expected, the revoked credential failed verification. The revocation registry is working correctly.</p>
                        </div>
                        <span class="badge bg-green text-green-fg">Expected Result</span>
                    {% elif session.demo.revocation_presentation_state == 'done' and session.demo.revocation_presentation_verified == 'true' %}
                        <div class="shape shape-md me-3">
                            <i class="ti ti-alert-triangle icon icon-1 text-warning"></i>
                        </div>
                        <div class="flex-fill">
                            <h4 class="mb-1 text-warning">Unexpected Result</h4>
                            <p class="text-muted mb-0">The revoked credential was verified as valid. This should not happen - check revocation registry.</p>
                        </div>
                        <span class="badge bg-yellow text-yellow-fg">Warning</span>
                    {% elif session.demo.revocation_presentation_state in ['request-sent', 'presentation-received'] %}
                        <div class="shape shape-md me-3">
                            <i class="ti ti-clock icon icon-1" style="color: #b45309;"></i>
                        </div>
                        <div class="flex-fill">
                            <h4 class="mb-1" style="color: #b45309;">Testing Revocation</h4>
                            <p class="text-muted mb-0">Presentation request sent. Please respond from your wallet to test the revoked credential.</p>
                        </div>
                        <span id="revocation-status-badge" class="badge bg-blue-lt">
                            <i class="ti ti-refresh spin me-1"></i>
                            {{ session.demo.revocation_presentation_state | title }}
                        </span>
                    {% else %}
                        <div class="shape shape-md me-3">
                            <i class="ti ti-clock icon icon-1 text-info"></i>
                        </div>
                        <div class="flex-fill">
                            <h4 class="mb-1 text-info">Processing Revocation Test</h4>
                            <p class="text-muted mb-0">Status: <code>{{ session.demo.revocation_presentation_state }}</code></p>
                        </div>
                        <span class="badge bg-info-lt">
                            <i class="ti ti-refresh spin me-1"></i>
                            Processing
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Revocation Explanation -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-info-circle me-2"></i>
                    What is Revocation?
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Credential revocation allows issuers to invalidate credentials even after they've been issued. This is important for scenarios like:
                </p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="shape shape-md me-3">
                                <i class="ti ti-school icon icon-1 text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Expired Status</h6>
                                <small class="text-muted">Student graduates or membership expires</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="shape shape-md me-3">
                                <i class="ti ti-key-off icon icon-1 text-warning"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Compromised Key</h6>
                                <small class="text-muted">Private key is lost or stolen</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="shape shape-md me-3">
                                <i class="ti ti-ban icon icon-1 text-danger"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Policy Violation</h6>
                                <small class="text-muted">Credential holder violated terms</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="{{ url_for('verification') }}" class="btn btn-outline-secondary">
                <i class="ti ti-arrow-left me-1"></i>
                Back to Verification
            </a>
            <div>
                {% if session.demo.revocation_presentation_state == 'done' %}
                    <a href="{{ url_for('results') }}" class="btn btn-primary">
                        View Results
                        <i class="ti ti-arrow-right ms-1"></i>
                    </a>
                {% else %}
                    <button class="btn btn-outline-warning" disabled>
                        <i class="ti ti-refresh spin me-1"></i>
                        Testing Revocation
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spin {
        display: inline-block;
        animation: spin 1s linear infinite;
    }
    
    .fade-update {
        animation: fadeUpdate 0.5s ease-in-out;
    }
    
    @keyframes fadeUpdate {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>

<script>
    // Auto-refresh functionality for revocation test status
    document.addEventListener('DOMContentLoaded', function() {
        {% if session.demo.revocation_presentation_state != 'done' %}
            const statusContent = document.getElementById('revocation-status-content');
            const navigationDiv = document.querySelector('.d-flex.justify-content-between.align-items-center.mt-4');
            
            // Auto-refresh every 3 seconds if test is not yet complete
            const autoRefreshInterval = setInterval(async function() {
                try {
                    console.log('Checking revocation test status...');
                    
                    // Fetch the current page
                    const response = await fetch("{{ url_for('revocation') }}");
                    const html = await response.text();
                    
                    // Parse the HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract the status card content
                    const newStatusContent = doc.getElementById('revocation-status-content');
                    const newNavigation = doc.querySelector('.d-flex.justify-content-between.align-items-center.mt-4');
                    
                    if (newStatusContent && statusContent) {
                        statusContent.classList.add('fade-update');
                        setTimeout(() => {
                            statusContent.innerHTML = newStatusContent.innerHTML;
                            statusContent.classList.remove('fade-update');
                        }, 250);
                    }
                    
                    if (newNavigation && navigationDiv) {
                        navigationDiv.innerHTML = newNavigation.innerHTML;
                    }
                    
                    // Check if revocation test is complete
                    if (newStatusContent && (
                        newStatusContent.innerHTML.includes('Revocation Verified') || 
                        newStatusContent.innerHTML.includes('bg-green') ||
                        newStatusContent.innerHTML.includes('Unexpected Result')
                    )) {
                        console.log('Revocation test complete!');
                        clearInterval(autoRefreshInterval);
                        
                        // Show notification
                        const isExpected = newStatusContent.innerHTML.includes('Revocation Verified');
                        const toast = document.createElement('div');
                        toast.className = 'toast show position-fixed top-0 end-0 m-3';
                        toast.style.zIndex = '9999';
                        toast.innerHTML = `
                            <div class="toast-header ${isExpected ? 'bg-success' : 'bg-warning'} text-white">
                                <i class="ti ti-${isExpected ? 'check' : 'alert-triangle'} me-2"></i>
                                <strong class="me-auto">${isExpected ? 'Test Passed' : 'Unexpected Result'}</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">
                                ${isExpected 
                                    ? 'Revoked credential failed verification as expected' 
                                    : 'Revoked credential was verified - check revocation registry'}
                            </div>
                        `;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 5000);
                    }
                    
                } catch (error) {
                    console.error('Error refreshing status:', error);
                }
            }, 3000);
            
            window.addEventListener('beforeunload', function() {
                clearInterval(autoRefreshInterval);
            });
        {% endif %}
    });
</script>
{% endblock %}
